#!/bin/bash
clear

# vars
bin_dir="$(dirname $(realpath $0))"
filename=$1
cur_script=""
script_no=0
heading=""
heading_path=""
section_no=()
depth=0

# include functions from lib
source "$bin_dir/../src/lib.bash"

# handle no file passed
if [ -z "$1" ]
then
  echo 'please provide a file to process or pass "init" to init this folder'
  echo
  exit
fi

# init
if [ "$1" = "init"  ]
then
  source "$bin_dir/../src/init.bash"
fi

# check if initted
if [ ! -d bash_down ]
then
  echo 'this folder is not initted for bash_down. please run "bash_down init"'
  echo
  exit
fi

# recreate output files
rm -rf bash_down/scripts
mkdir bash_down/scripts
rm -rf bash_down/tests
mkdir bash_down/tests
rm bash_down/spec.md
touch bash_down/spec.md

# iterate through lines in file and decide how to parse/output them
while read -r line
do
  # run through parser if we have a local path after #!
  if [ ! -z "$(echo $line | grep -e '^[ ]*#![^ /].*$')" ]
  then
    local_parser

  # inline script - #!/some/shell
  elif [ ! -z "$(echo $line | grep -e '^[ ]*#![/]*.*$')" ]
  then
    inline_script

  # execute and clear cur script if we get !#
  elif [ ! -z "$(echo $line | grep -e '^[ ]*!#$')" ]
  then
    inline_script_close

  # commented script
  elif [ ! -z "$(echo $line | grep -e '^[ ]*##![/]*.*$')" ]
  then
    commented_script="$heading_path"

  # write to current script if we have one
  elif [ ! -z "$cur_script" ]
  then
    if [ -z "$commented_script" ]
    then
      echo $line >> "$cur_script"
    else
      commented_script=""
    fi

  # heading
  elif [ ! -z "$(echo $line | grep -e '^#')" ]
  then
    heading
    
  # just write to markdown
  else
    echo $line >> bash_down/spec.md
  fi

  # if it starts with #!/some_shell write and run a script with all lines until !# on its own line unless there is a one line command on the same line
  # if it starts with #!some_local_path parse the line with a script in the bin folder
  # if it is the !# then clear out cur_script
done < "$filename"

# then execute the runners
for file in bash_down/tests/*
do
  if [ -s $file ]
  then
    output=`"./bash_down/runners/$file" "./bash_down/tests/$file"`
    cat<<<"$output"
  fi
done
